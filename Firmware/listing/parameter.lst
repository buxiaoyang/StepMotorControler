C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 1   


C51 COMPILER V7.50, COMPILATION OF MODULE PARAMETER
OBJECT MODULE PLACED IN .\output\parameter.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE source\parameter.c LARGE BROWSE INCDIR(.\include\) DEBUG OBJECTEXTEND PRINT
                    -(.\listing\parameter.lst) OBJECT(.\output\parameter.obj)

line level    source

   1          #include "parameter.h"
   2          #include "screen.h"
   3          #include "eeprom.h"
   4          #include "timer.h"
   5          #include "uart.h"
   6          #include "debug.h"
   7          
   8          #define REVERSE_DIRECTION
   9          
  10          // µÚ¶þµç»úÔËÐÐÊÇ·ñÐèÒªÓÉÓÃ»§¿ØÖÆ
  11          //#define USER_CONTROL 
  12          
  13          //TODO:Ê¹ÓÃ½á¹¹Ìå·â×°
  14          /***************************************************************************/
  15          // ²ÎÊý¶¨Òå     
  16          /***************************************************************************/
  17          unsigned char currentPosition;  //µ±Ç°Î»ÖÃ 1~20
  18          unsigned int  pulseSettingNum;  //Âö³å¸öÊý
  19          unsigned int  pulseSettingFreq; //Âö³åÆµÂÊ
  20          unsigned int  motorStepAngle;   //µç»ú²½½ø½Ç
  21          unsigned int  screwPitch;       //Ë¿¸ËË¿¾à
  22          unsigned int  motorReducGearRatio; //µç»ú¼õËÙ±È
  23          
  24          unsigned long  ballScrew;          //Ë¿¸Ëµ¼³Ì
  25          unsigned long  motorRotationAngle; //µç»úÐý×ª½Ç
  26          unsigned char isStartPosition;     //³õÊ¼Î»ÖÃ
  27          unsigned char isStartPosition1;    //³õÊ¼Î»ÖÃ
  28          unsigned char isStartPosition2;    //³õÊ¼Î»ÖÃ
  29          
  30          // unused
  31          unsigned char initFlag = 0; //³õÊ¼»¯±êÖ¾Î»
  32          
  33          BOOL refreshDisplay = FALSE; //Ë¢ÐÂÆÁÄ»±êÖ¾Î» 0 ²»Ë¢ÐÂ 1Ë¢ÐÂ
  34          BOOL saveSetting = FALSE; // ±£´æ²ÎÊý±êÖ¾Î»
  35          
  36          static BOOL inputChanged = FALSE;
  37          static int  motorAction = MOTOR_UNKOWN;
  38          static unsigned int rotationAngles[ROTATIONANGLE_SIZE] = {0};
  39          static int rotationAngleNumber = 0;
  40          static int currentRotationAngleIndex = -1;
  41          
  42          // ÓÃÓÚÖ§³ÖÁíÍâÒ»¸öµç»ú
  43          static BOOL startSecondMotor = FALSE;
  44          static int currentMotor = MOTORFLAG_UNKOWN;
  45          
  46          static unsigned int currentPulseNum = 0;
  47          
  48          // ÓÃÓÚ²âÊÔµç»ú
  49          static BOOL testMode = FALSE;
  50          static BOOL controlTogether = FALSE;
  51          static unsigned int testPulseSettingNum = 10000;
  52          
  53          static BOOL userControl = FALSE;
  54          static BOOL waitUserControl = FALSE;
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 2   

  55          
  56          // Èç¹ûÔÚµÚÒ»¸öµç»ú½áÊø£¬µÚ¶þ¸öµç»úÔË¶¯Ö®Ç°¶Ïµç£¬Ôò±£´æµ±Ç°×´Ì¬
  57          static BOOL saveFirstAction = FALSE;
  58          
  59          static BOOL saveCurrentPosition = TRUE;
  60          
  61          static int currentPage = 0;
  62          
  63          void SetCurrentPage(int page)
  64          {
  65   1              currentPage = page;
  66   1      }
  67          
  68          void SaveSnapshot()
  69          {
  70   1              if (saveFirstAction)
  71   1              {
  72   2                      saveFirstAction = FALSE;
  73   2                      IapProgramByte(IAP_ADDRESS+100, 0xEE); //Ð´Èë±êÖ¾Î»
  74   2                      IapProgramByte(IAP_ADDRESS+101, userControl);
  75   2                      IapProgramByte(IAP_ADDRESS+102, waitUserControl);
  76   2      
  77   2                      IapProgramByte(IAP_ADDRESS+103, (BYTE)(currentMotor>>8));
  78   2                      IapProgramByte(IAP_ADDRESS+104, (BYTE)currentMotor);
  79   2      
  80   2                      IapProgramByte(IAP_ADDRESS+105, (BYTE)(motorAction>>8));
  81   2                      IapProgramByte(IAP_ADDRESS+106, (BYTE)motorAction);
  82   2      
  83   2                      IapProgramByte(IAP_ADDRESS+107, (BYTE)(pulseSettingNum>>8));
  84   2                      IapProgramByte(IAP_ADDRESS+108, (BYTE)pulseSettingNum);
  85   2      
  86   2                      secondMotorFlag = 1;
  87   2              }
  88   1      }
  89          
  90          void RestoreSnapshot()
  91          {
  92   1              if (IapReadByte(IAP_ADDRESS+100) == 0xEE)
  93   1              {       
  94   2                      userControl = IapReadByte(IAP_ADDRESS+101);
  95   2                      waitUserControl = IapReadByte(IAP_ADDRESS+102);
  96   2                      currentMotor = ((IapReadByte(IAP_ADDRESS+103) << 8) | IapReadByte(IAP_ADDRESS+104));
  97   2                      motorAction = ((IapReadByte(IAP_ADDRESS+105) << 8) | IapReadByte(IAP_ADDRESS+106));
  98   2                      pulseSettingNum = ((IapReadByte(IAP_ADDRESS+107) << 8) | IapReadByte(IAP_ADDRESS+108));
  99   2      
 100   2                      if (userControl == TRUE)
 101   2                      {
 102   3                              startSecondMotor = TRUE;        
 103   3                      }
 104   2              }
 105   1      }
 106          
 107          void UserControl()
 108          {
 109   1              if (motorAction != MOTORDIRECTION_FORWARD && motorAction != MOTORDIRECTION_BACKWARD)
 110   1              {
 111   2                      return;
 112   2              }
 113   1              userControl = TRUE;
 114   1              StartSecondMotor();
 115   1      }
 116          
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 3   

 117          static void DebugParameters()
 118          {
 119   1              int i;
 120   1              DebugParameter("pulseSettingNum", pulseSettingNum);
 121   1              DebugParameter("pulseSettingFreq", pulseSettingFreq);
 122   1              DebugParameter("motorStepAngle", motorStepAngle);
 123   1              DebugParameter("motorReducGearRatio", motorReducGearRatio);
 124   1              DebugParameter("motorRotationAngle", motorRotationAngle);
 125   1              DebugParameter("screwPitch", screwPitch);
 126   1              DebugParameter("ballScrew", ballScrew);
 127   1              DebugParameter("currentPosition", currentPosition);
 128   1              DebugParameter("isStartPosition", IsInitPosition()); 
 129   1              for (i = 0; i < ROTATIONANGLE_SIZE; i++)
 130   1              {
 131   2                      DebugParameter1(i + 1, rotationAngles[i]);
 132   2              } 
 133   1      }
 134          
 135          // ¿ØÖÆµ¥Æ¬»úÒý½Å
 136          void SetMotorForward()
 137          {
 138   1              if (currentMotor == MOTORFLAG_TWO)
 139   1              {
 140   2                      #ifndef REVERSE_DIRECTION
                                      secondMotorDirection = 1;
                              #else
 143   2                              secondMotorDirection = 0;
 144   2                      #endif
 145   2              }
 146   1              else if (currentMotor == MOTORFLAG_ONE)
 147   1              {
 148   2                      #ifndef REVERSE_DIRECTION
                                      motorDirection = 1;
                              #else
 151   2                              motorDirection = 0;
 152   2                      #endif
 153   2              }
 154   1      }
 155          
 156          void SetMotorBackward() 
 157          {
 158   1              if (currentMotor == MOTORFLAG_TWO)
 159   1              {
 160   2                      #ifndef REVERSE_DIRECTION
                                      secondMotorDirection = 0;
                              #else
 163   2                              secondMotorDirection = 1;
 164   2                      #endif
 165   2              }
 166   1              else if (currentMotor == MOTORFLAG_ONE)
 167   1              {
 168   2                      #ifndef REVERSE_DIRECTION
                                      motorDirection = 0;
                              #else
 171   2                              motorDirection = 1;
 172   2                      #endif
 173   2              }       
 174   1      }
 175          
 176          void DisablePulse()
 177          {
 178   1              if (testMode == TRUE && controlTogether == TRUE)
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 4   

 179   1              {
 180   2                      secondMotorPWM = 1;
 181   2                      motorPWM = 1;
 182   2              }
 183   1              else
 184   1              {
 185   2                      if (currentMotor == MOTORFLAG_TWO)
 186   2                      {
 187   3                              secondMotorPWM = 1;
 188   3                      }
 189   2                      else if (currentMotor == MOTORFLAG_ONE)
 190   2                      {
 191   3                              motorPWM = 1;
 192   3                      }
 193   2              }
 194   1      }
 195          
 196          void ChangePulse()
 197          {
 198   1              if (testMode == TRUE && controlTogether == TRUE)
 199   1              {
 200   2                      secondMotorPWM = ~secondMotorPWM;
 201   2                      motorPWM = ~motorPWM;
 202   2              }
 203   1              else
 204   1              {
 205   2                      if (currentMotor == MOTORFLAG_TWO)
 206   2                      {
 207   3                              secondMotorPWM = ~secondMotorPWM;
 208   3                      }
 209   2                      else if (currentMotor == MOTORFLAG_ONE)
 210   2                      {
 211   3                              motorPWM = ~motorPWM;
 212   3                      }
 213   2              }
 214   1      }
 215          
 216          void UpdateParameters()
 217          {
 218   1              unsigned long temp1 = 0;
 219   1              unsigned long temp2 = 0;
 220   1              
 221   1              switch (motorAction)
 222   1              {
 223   2              case MOTORDIRECTION_FORWARD:
 224   2                      currentPosition++;
 225   2                      // TODO:ÉèÖÃ²ÎÊýºó¿ÉÒÔ¼ÆËã²¢±£´æÏÂÀ´
 226   2                      //¼ÆËãµç»úÐý×ª½Ç:Âö³å¸öÊý*µç»ú²½½ø½Ç(pulseSettingNum * 1.8*100)
 227   2                      temp1 = (unsigned long)currentPulseNum * 180;// ´¥ÃþÆÁÍ¨¹ý´®¿Ú¶¼ÊÇÒÔÕûÊýÀ´·¢ËÍ£
 228   2                      // ÎªÊ²Ã´Ê¹ÓÃpulseSettingNum²»ÐÐ?
 229   2                      temp2 = (unsigned long)temp1 * screwPitch / 36000;
 230   2                      motorRotationAngle  = temp1;
 231   2                      ballScrew = temp2;
 232   2                      break;
 233   2              case MOTORDIRECTION_BACKWARD:
 234   2                      currentPosition--;
 235   2                      // TODO:ÉèÖÃ²ÎÊýºó¿ÉÒÔ¼ÆËã²¢±£´æÏÂÀ´
 236   2                      //¼ÆËãµç»úÐý×ª½Ç:Âö³å¸öÊý*µç»ú²½½ø½Ç(pulseSettingNum * 1.8*100)
 237   2                      temp1 = (unsigned long)currentPulseNum * 180;// ´¥ÃþÆÁÍ¨¹ý´®¿Ú¶¼ÊÇÒÔÕûÊýÀ´·¢ËÍ£
 238   2                      // ÎªÊ²Ã´Ê¹ÓÃpulseSettingNum²»ÐÐ?
 239   2                      temp2 = (unsigned long)temp1 * screwPitch / 36000;
 240   2                      motorRotationAngle = temp1;
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 5   

 241   2                      ballScrew = temp2;
 242   2                      break;
 243   2              }       
 244   1      }
 245          
 246          void StartSecondMotor()
 247          {
 248   1              if (/*startSecondMotor &&*/ userControl)
 249   1              {
 250   2                      startSecondMotor = FALSE;
 251   2                      userControl = FALSE;
 252   2                      waitUserControl = FALSE;
 253   2                      
 254   2                      DebugParameter("StartSecondMotor motorAction", motorAction);
 255   2                      // µÈ´ýµç»úÍ£Ö¹
 256   2                      //delay_ms(1000);
 257   2                      if (motorAction == MOTORDIRECTION_FORWARD)
 258   2                      {
 259   3                              currentMotor = MOTORFLAG_TWO;
 260   3                              SetMotorForward();
 261   3                      }
 262   2                      else if (motorAction == MOTORDIRECTION_BACKWARD)
 263   2                      {
 264   3                              currentMotor = MOTORFLAG_TWO;
 265   3                              SetMotorBackward();
 266   3                      }
 267   2                      
 268   2                      SyncRotationAngle();
 269   2                      if (pulseSettingNum == 0)
 270   2                      {
 271   3                              return;
 272   3                      }
 273   2                      SetTimerParameter(50, pulseSettingNum);
 274   2                      userControlFlag = 0;
 275   2              }
 276   1      }
 277          
 278          // ÓÉTimerÄ£¿éµ÷ÓÃ
 279          void FinishPulse()
 280          {
 281   1              // µÈ´ýÓÃ»§ÊäÈë£¬µÚ¶þ¸öµç»ú²ÅÄÜÔËÐÐ
 282   1              if (waitUserControl)
 283   1              {
 284   2                      return;
 285   2              }
 286   1              
 287   1              switch (motorAction)
 288   1              {
 289   2                      case MOTOR_UNKOWN:
 290   2                              return;
 291   2                      case MOTOR_INIT:
 292   2                              if (currentMotor == MOTORFLAG_ONE)
 293   2                              {
 294   3                                      Debug("FinishPulse MOTORFLAG_ONE\r\n");
 295   3                                      motorAction = MOTOR_INIT;
 296   3                                      currentMotor = MOTORFLAG_TWO;
 297   3                                      /*
 298   3                                      #ifndef REVERSE_DIRECTION
 299   3                                              secondMotorDirection = 0; // µÚ¶þ¸öµç»úºóÍË
 300   3                                      #else
 301   3                                              secondMotorDirection = 1;
 302   3                                      #endif
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 6   

 303   3                                      */
 304   3                                      SetMotorBackward();
 305   3                                      SetTimerParameter(50, 65535);           
 306   3                                      waitUserControl = FALSE;
 307   3                              }
 308   2                              else if (currentMotor == MOTORFLAG_TWO)
 309   2                              {
 310   3                                      Debug("FinishPulse MOTORFLAG_TWO\r\n");
 311   3                                      // ¸üÐÂÏÔÊ¾ÆÁ
 312   3                                      currentPosition = 1;
 313   3                                      currentMotor = MOTORFLAG_UNKOWN;
 314   3                                      motorAction = MOTOR_UNKOWN;
 315   3                                      // ²»ÄÜÁ¢¼´Ë¢ÐÂ£¬·ñÔò»á×èÈû
 316   3                                      EnableRefreshDisplay();
 317   3                                      EnableSaveSetting();
 318   3                                      saveCurrentPosition = TRUE;
 319   3                              }
 320   2                              break;
 321   2                      case MOTORDIRECTION_FORWARD:
 322   2                      case MOTORDIRECTION_BACKWARD:
 323   2                              if (currentMotor == MOTORFLAG_ONE)
 324   2                              {
 325   3                                      // µÚ¶þ¸öµç»úÇ°½øµÄÍ¬Ê±µÚÒ»¸öµç»úºóÍË
 326   3                                      if (testMode == TRUE)
 327   3                                      {       
 328   4                                              #ifndef REVERSE_DIRECTION
                                                              motorDirection = 0;
                                                              secondMotorDirection = 1;
                                                      #else
 332   4                                                      motorDirection = 1;
 333   4                                                      secondMotorDirection = 0;
 334   4                                              #endif
 335   4                                              currentMotor = MOTORFLAG_TWO;
 336   4                                              motorAction = MOTORDIRECTION_FORWARD;
 337   4                                              controlTogether = TRUE;
 338   4                                              SetTimerParameter(50, testPulseSettingNum);
 339   4                                              return;
 340   4                                      }
 341   3                                      waitUserControl = TRUE;
 342   3                                      startSecondMotor = TRUE;
 343   3                                      currentMotor = MOTORFLAG_TWO;
 344   3      
 345   3                                      saveFirstAction = TRUE;
 346   3                                      saveCurrentPosition = FALSE;
 347   3                                      EnableSaveSetting();
 348   3                                      
 349   3                                      //SaveParameters();
 350   3                                      
 351   3                                      secondMotorFlag = 1;
 352   3                              }
 353   2                              else if (currentMotor == MOTORFLAG_TWO)
 354   2                              {
 355   3                                      //UpdateParameters();
 356   3                                      if (testMode == TRUE)
 357   3                                      {
 358   4                                              if (motorAction == MOTORDIRECTION_FORWARD)
 359   4                                              {
 360   5                                                      #ifndef REVERSE_DIRECTION
                                                                      secondMotorDirection = 0;
                                                              #else
 363   5                                                              secondMotorDirection = 1;
 364   5                                                      #endif
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 7   

 365   5                                                      
 366   5                                                      controlTogether = FALSE;
 367   5                                                      currentMotor = MOTORFLAG_TWO;
 368   5                                                      motorAction = MOTORDIRECTION_BACKWARD;
 369   5                                                      // ¿ØÖÆ²âÊÔÖ¸Ê¾µÆÁÁ
 370   5                                                      //secondMotorFlag = 0;
 371   5                                                      SetTimerParameter(50, testPulseSettingNum);
 372   5                                              }
 373   4                                              else if (motorAction == MOTORDIRECTION_BACKWARD)
 374   4                                              {
 375   5                                                      testMode = FALSE;
 376   5                                                      isStartPosition1 = 1;
 377   5                                                      isStartPosition2 = 1;
 378   5                                                      currentMotor = MOTORFLAG_UNKOWN;
 379   5                                                      motorAction = MOTOR_UNKOWN;
 380   5                                                      // ¿ØÖÆ²âÊÔÖ¸Ê¾µÆÃð
 381   5                                                      //secondMotorFlag = 1;
 382   5                                                      // ²»ÄÜÁ¢¼´Ë¢ÐÂ£¬·ñÔò»á×èÈû
 383   5                                                      EnableRefreshDisplay();
 384   5                                                      //EnableSaveSetting();
 385   5                                              }
 386   4                                              return;
 387   4                                      }
 388   3                                      
 389   3                                      if (motorAction == MOTORDIRECTION_FORWARD)
 390   3                                              currentPosition++;
 391   3                                      else if (motorAction == MOTORDIRECTION_BACKWARD)
 392   3                                              currentPosition--;
 393   3                                      startSecondMotor = FALSE;
 394   3                                      currentMotor = MOTORFLAG_UNKOWN;
 395   3                                      motorAction = MOTOR_UNKOWN;
 396   3                                      // ²»ÄÜÁ¢¼´Ë¢ÐÂ£¬·ñÔò»á×èÈû
 397   3                                      EnableRefreshDisplay();
 398   3                                      EnableSaveSetting(); // ---±£´æºÄÊ±»á²»»áÓ°ÏìÎÈ¶¨ÐÔ?
 399   3      
 400   3                                      userControlFlag = 1;
 401   3                              }
 402   2                              break;
 403   2                      default:
 404   2                              return;
 405   2              }       
 406   1      }
 407          
 408          //====================================
 409          void InitHardware()
 410          {
 411   1              uart_init();
 412   1              timer_init();
 413   1              InitDebug();
 414   1      }
 415          
 416          void EnableRefreshDisplay()
 417          {
 418   1              refreshDisplay = TRUE;
 419   1      }
 420          
 421          void EnableSaveSetting()
 422          {
 423   1              saveSetting = TRUE;
 424   1      }
 425          
 426          void DisableRefreshDisplay()
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 8   

 427          {
 428   1              refreshDisplay = FALSE;
 429   1      }
 430          
 431          void DisableSaveSetting()
 432          {
 433   1              saveSetting = FALSE;
 434   1      }
 435          
 436          BOOL IsRefreshDisplay()
 437          {
 438   1              return refreshDisplay;
 439   1      }
 440          
 441          BOOL IsSaveSetting()
 442          {
 443   1              return saveSetting;
 444   1      }
 445          
 446          BOOL IsInitPosition()
 447          {
 448   1              if (currentPosition == MOTORPOSITION_BEGIN)
 449   1              {
 450   2                      return TRUE;
 451   2              }
 452   1              else
 453   1              {
 454   2                      return FALSE;
 455   2              }
 456   1      }
 457          
 458          // ½âÎö´®¿Ú·¢ËÍ¹ýÀ´µÄÃüÁî£¬È¥³ýÖ¡Í·ºÍÊý¾Ý³¤¶È£¬Ö»°üº¬Ö¸ÁîºÍÊý¾ÝÁ½²¿·Ö
 459          // [5A A5 06] 83 00 00 01 01 F4 
 460          void ParseCommand(unsigned char* buf, int len)
 461          {
 462   1              int addr = 0;
 463   1              int size = 0;
 464   1              int dat = 0;
 465   1              // TODO: ²ÎÊý¼ì²é
 466   1              len = len;
 467   1              // ±äÁ¿µØÖ·£¬Õ¼ÓÃÁ½¸ö×Ö½Ú
 468   1              addr = ((buf[1] << 8) | buf[2]);
 469   1              // ±äÁ¿µÄ³¤¶È£¬Õ¼ÓÃ1¸ö×Ö½Ú
 470   1              size = buf[3];
 471   1              if (size != 0x01) return;
 472   1              // ±äÁ¿µÄÖµ£¬Õ¼ÓÃsize¸ö×Ö
 473   1              dat = ((buf[4] << 8) | buf[5]);
 474   1      
 475   1              // ²ÎÊýÉèÖÃÒ³ÃæÖÐÊäÈë¿ò
 476   1              if (addr == 0x0000 || addr == 0x0002 || addr == 0x0004 || addr == 0x0006 || 
 477   1              addr == 0x0008 || addr == 0x000A || addr == 0x000C) 
 478   1              {
 479   2                      DebugFunction("SetParameter", addr, dat);
 480   2                      SetParameter(addr, dat);
 481   2              }
 482   1              // Ðý×ª½ÇÉèÖÃÒ³ÃæÖÐÊäÈë¿ò
 483   1              else if (addr >= SCREEN_ROTATIONANGLE_BEGIN && addr <= SCREEN_ROTATIONANGLE_END)
 484   1              {
 485   2                      DebugFunction("SetRotationAngle", addr, dat);
 486   2                      SetRotationAngle(addr, dat);
 487   2              }
 488   1              // ·µ»Ø°´Å¥
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 9   

 489   1              else if (addr == 0x000E || addr == 0x001E || addr == 0x002E)
 490   1              {
 491   2                      DebugFunction("HandleReturn", addr, dat);
 492   2                      HandleReturn(addr, dat);
 493   2              }
 494   1              // µç»ú¿ØÖÆ°´Å¥
 495   1              else if (addr == 0x0014 || addr == 0x0016 || addr == 0x0018)
 496   1              {
 497   2                      DebugFunction("HandleMotor", addr, dat);
 498   2                      HandleMotor(addr, dat);
 499   2              }
 500   1              // ÆäËû°´Å¥
 501   1              else if (addr == 0x00F0 || addr == 0x00F2 || addr == 0x00F4 || addr == 0x00F6) 
 502   1              {
 503   2                      DebugFunction("HandleButtuon", addr, dat);
 504   2                      HandleButtuon(addr, dat);
 505   2              }
 506   1              else
 507   1              {
 508   2                      DebugFunction("error", addr, dat);
 509   2              }
 510   1      }
 511          
 512          void HandleButtuon(int addr, int dat)
 513          {
 514   1              dat = dat;
 515   1              // ²ÎÊýÉèÖÃ°´Å¥
 516   1              if (addr == 0x00F0) 
 517   1              {
 518   2                      ChangeScreenPage(0x02);
 519   2              }
 520   1              // ²ÎÊýÉèÖÃ½çÃæÖÐ¸ü¶à°´Å¥
 521   1              else if (addr == 0x00F2) 
 522   1              { 
 523   2                      ChangeScreenPage(0x07);
 524   2              }
 525   1              // Ðý×ª½ÇÉèÖÃ½çÃæÖÐÏÂÒ»Ò³°´Å¥
 526   1              else if (addr == 0x00F4) 
 527   1              { 
 528   2                      ChangeScreenPage(0x08);
 529   2              }
 530   1              // Ðý×ª½ÇÉèÖÃ½çÃæÖÐÉÏÒ»Ò³°´Å¥
 531   1              else if (addr == 0x00F6) 
 532   1              { 
 533   2                      ChangeScreenPage(0x07);
 534   2              }
 535   1              EnableRefreshDisplay();
 536   1      }
 537          
 538          void HandleReturn(int addr, int dat)
 539          {
 540   1              int page = 0;
 541   1              dat = dat;
 542   1              // ÇÐ»»ÆÁÄ»
 543   1              if (addr == 0x000E)
 544   1              {
 545   2                      page = 0x00;
 546   2              }
 547   1              else if (addr == 0x001E || addr == 0x002E)
 548   1              { 
 549   2                      page = 0x02;
 550   2                      SyncRotationAngleNumber();
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 10  

 551   2              } 
 552   1              
 553   1              if (inputChanged)
 554   1              {
 555   2                      inputChanged = FALSE;
 556   2                      ChangeScreenPage(0x04);
 557   2                      // ÎªÁËÏÔÊ¾±£´æ½çÃæ£¬ÕâÀïÑÓÊ±1s
 558   2                      delay_ms(1000);
 559   2                      SaveParametersToEEPROM();
 560   2              }
 561   1              ChangeScreenPage(page);
 562   1              EnableRefreshDisplay();// added 
 563   1      }
 564          
 565          void HandleMotor(int addr, int dat)
 566          {
 567   1              if (addr == 0x0014) //³õÊ¼»¯°´Å¥
 568   1              {
 569   2                      DebugFunction("InitMotor", addr, dat);
 570   2                      InitMotor();
 571   2              }
 572   1              else if (addr == 0x0016) //ºóÍË°´Å¥
 573   1              {
 574   2                      DebugFunction("ControlMotor:backward", addr, dat);
 575   2                      ControlMotor(MOTORDIRECTION_BACKWARD);
 576   2              }
 577   1              else if (addr == 0x0018) //Ç°½ø°´Å¥
 578   1              {
 579   2                      DebugFunction("ControlMotor:forward", addr, dat);
 580   2                      ControlMotor(MOTORDIRECTION_FORWARD);
 581   2              }
 582   1              else
 583   1              {
 584   2                      dat = dat;
 585   2              }
 586   1      }
 587          
 588          void InitMotor()
 589          {
 590   1              // Èç¹ûµç»úÕýÔÚÔËÐÐ£¬²»ÏìÓ¦ÓÃ»§²Ù×÷£¬Ò²²»¼ÇÂ¼ÓÃ»§²Ù×÷
 591   1              if (motorAction != MOTOR_UNKOWN || startSecondMotor)
 592   1              {
 593   2                      Debug("motor running\r\n");
 594   2                      DebugParameter("motorAction", motorAction);
 595   2                      return;
 596   2              }
 597   1              // Èç¹ûµ±Ç°Î»ÖÃÎª1£¬Ôòµç»ú²»ÐèÒªÔË×ª
 598   1              if (currentPosition == MOTORPOSITION_BEGIN)
 599   1              {
 600   2                      Debug("motor at begin\r\n");
 601   2                      return;
 602   2              }
 603   1      
 604   1              Debug("InitMotor\r\n");
 605   1              motorAction = MOTOR_INIT;
 606   1              currentMotor = MOTORFLAG_ONE;
 607   1              SetMotorBackward();
 608   1              SetTimerParameter(50, 65535);   
 609   1              waitUserControl = FALSE;
 610   1              userControl = FALSE;
 611   1      }
 612          
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 11  

 613          // TODO:µ±Ç°Î»ÖÃ·¶Î§Îª1-20£¬ÎÞ·¨¼ÌÐøÇ°½ø»òºóÍËÊ±Í¨¹ý½çÃæ¸ø³öÌáÊ¾
 614          void ControlMotor(int direction)
 615          {
 616   1              int position = 0;
 617   1              #if 1
 618   1              // µ±Ç°µç»úÎ´ÔËÐÐ½áÊø
 619   1              if (motorAction != MOTOR_UNKOWN/* || startSecondMotor*/)
 620   1              {
 621   2                      Debug("motor running\r\n");
 622   2                      DebugParameter("motorAction", motorAction);
 623   2                      // ÊÇ·ñÒª¼ÇÂ¼²Ù×÷
 624   2                      return;
 625   2              }
 626   1              #endif
 627   1              
 628   1              DebugParameter("ControlMotor:direction", direction);
 629   1      
 630   1              userControl = FALSE;
 631   1              if (direction == MOTORDIRECTION_FORWARD)
 632   1              {
 633   2                      position = currentPosition + 1;
 634   2                      if (position > MOTORPOSITION_END || position <= MOTORPOSITION_BEGIN)
 635   2                      {
 636   3                              #if 0
                                              ChangeScreenPage(0x09);
                                              // ÎªÁËÏÔÊ¾±£´æ½çÃæ£¬ÕâÀïÑÓÊ±1s
                                              delay_ms(1000);
                                              ChangeScreenPage(0x00);
                                      #endif
 642   3                              return;
 643   3                      }
 644   2                      motorAction = MOTORDIRECTION_FORWARD;
 645   2                      currentMotor = MOTORFLAG_ONE;
 646   2                      SetMotorForward();
 647   2              }
 648   1              else if (direction == MOTORDIRECTION_BACKWARD)
 649   1              {
 650   2                      position = currentPosition - 1;
 651   2                      if (position < MOTORPOSITION_BEGIN ||  position >= MOTORPOSITION_END )
 652   2                      {
 653   3                              #if 0
                                      ChangeScreenPage(0x0A);
                                      // ÎªÁËÏÔÊ¾±£´æ½çÃæ£¬ÕâÀïÑÓÊ±1s
                                      delay_ms(1000);
                                      ChangeScreenPage(0x00);
                                      #endif
 659   3                              return;
 660   3                      }
 661   2                      motorAction = MOTORDIRECTION_BACKWARD;
 662   2                      currentMotor = MOTORFLAG_ONE;
 663   2                      SetMotorBackward();     
 664   2              }
 665   1              else
 666   1              {
 667   2                      return;
 668   2              }
 669   1              SyncRotationAngle();
 670   1              if (pulseSettingNum == 0)
 671   1              {
 672   2                      return;
 673   2              }
 674   1              SetTimerParameter(50, pulseSettingNum);
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 12  

 675   1      
 676   1              secondMotorFlag = 0;
 677   1      }
 678          
 679          // ³õÊ¼Î»ÖÃÊ±²Å¿ÉÒÔ½øÐÐ²âÊÔ£¬²âÊÔµÄ²½½ø½Ç¹Ì¶¨
 680          void TestMotor()
 681          {
 682   1              #ifdef VERBOSE
                              DebugParameter("testMode", testMode);
                              DebugParameter("controlTogether", controlTogether);
                              DebugParameter("isStartPosition1", isStartPosition1);
                              DebugParameter("isStartPosition2", isStartPosition2);
                              DebugParameter("currentPosition", currentPosition);
                      #endif
 689   1              // isStartPosition1 == 1 && isStartPosition2 == 1?
 690   1              if (testMode != TRUE && IsInitPosition())
 691   1              {
 692   2              #ifdef VERBOSE
                              Debug("TestMotor...\r\n");      
                              Debug("TestMotor MOTORFLAG_ONE begin.\r\n");
                      #endif
 696   2                      testMode = TRUE;
 697   2                      currentMotor = MOTORFLAG_ONE;
 698   2                      motorAction = MOTORDIRECTION_FORWARD;
 699   2      
 700   2                      #ifndef REVERSE_DIRECTION
                                      motorDirection = 1;
                              #else
 703   2                              motorDirection = 0;
 704   2                      #endif
 705   2                      controlTogether = FALSE;
 706   2                      SetTimerParameter(50, testPulseSettingNum);
 707   2              }
 708   1      }
 709          
 710          // TODO:¸ÄÐ´¸Ãº¯Êý
 711          void GetSensorStatus()
 712          {
 713   1              //³õÊ¼Î»ÖÃ´«¸ÐÆ÷
 714   1              if (sensorStartPosi1 == 0)
 715   1              {
 716   2                      if(isStartPosition1 == 0)
 717   2                      {
 718   3                              refreshDisplay = 1;
 719   3                      }
 720   2                      isStartPosition1 = 1;
 721   2              }
 722   1              if (sensorStartPosi1 == 1)
 723   1              {
 724   2                      if(isStartPosition1 == 1)
 725   2                      {
 726   3                              refreshDisplay = 1;
 727   3                      }
 728   2                      isStartPosition1 = 0;
 729   2              }
 730   1              //³õÊ¼Î»ÖÃ´«¸ÐÆ÷2
 731   1              if (sensorStartPosi2 == 0)
 732   1              {
 733   2                      if(isStartPosition2 == 0)
 734   2                      {
 735   3                              refreshDisplay = 1;
 736   3                      }
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 13  

 737   2                      isStartPosition2 = 1;
 738   2              }
 739   1              if (sensorStartPosi2 == 1)
 740   1              {
 741   2                      if(isStartPosition2 == 1)
 742   2                      {
 743   3                              refreshDisplay = 1;
 744   3                      }
 745   2                      isStartPosition2 = 0;
 746   2              }
 747   1              //µç´ÅÌúÊäÈë
 748   1              if (electromagnetIn == 0)
 749   1              {
 750   2                      electromagnetOut = 0;
 751   2              }
 752   1              else
 753   1              {
 754   2                      electromagnetOut = 1;
 755   2              }
 756   1      }
 757          
 758          void CheckSensorInput()
 759          {
 760   1      #if 0
                      //Get the sensor status
                      GetSensorStatus();
                      // ----Èç¹ûÁ½¸ö´«¸ÐÆ÷ÓÐÒ»¸öÓÐÐÅºÅ¾ÍËµÃ÷ÊÇ¿ªÊ¼Î»ÖÃ
                      if (isStartPosition2 || isStartPosition1)
                      {
                              isStartPosition = 1;
                      }
                      /*
                      else if (!isStartPosition2 && !isStartPosition1)
                      {
                              isStartPosition = 0;
                      }
                      */
                      //³õÊ¼»¯¹ý³ÌÖÐÅÐ¶ÏÔ­µã
                      if (motorAction == MOTOR_INIT && (isStartPosition2 || isStartPosition1))
                      {
                              Debug("CheckSensorInput\r\n");
                              isStartPosition1 = 0;
                              isStartPosition2 = 0;
                              initFlag = 0;
                              //pulseSettingNumCount = 4;
                              if (isStartPosition1)
                              {
              
                              }
                              else if (isStartPosition2)
                              {
              
                              }
                              //SetTimerParameter(0, 4);
                              //SetTimerParameter(50, 4);
                              StopPulseTimer();
                      }
              #endif
 795   1      
 796   1              if (motorAction == MOTOR_INIT)
 797   1              {
 798   2                      if (currentMotor == MOTORFLAG_ONE)
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 14  

 799   2                      {
 800   3                              if (sensorStartPosi1 == 0)
 801   3                              {
 802   4                                      StopPulseTimer();
 803   4                              }
 804   3                      }
 805   2                      else if (currentMotor == MOTORFLAG_TWO)
 806   2                      {
 807   3                              if (sensorStartPosi2 == 0)
 808   3                              {
 809   4                                      StopPulseTimer();
 810   4                                      // Êä³öµÍµçÆ½¸øÓèÓÃ»§·´À¡
 811   4                                      sensorStartFlag = 0;
 812   4                                      delay_ms(1);
 813   4                                      sensorStartFlag = 1;
 814   4                              }
 815   3                      }
 816   2              }
 817   1      }
 818          
 819          void ResetParameters()
 820          {
 821   1              Debug("Reset parameters...\r\n");       
 822   1              pulseSettingNum = 0;
 823   1              pulseSettingFreq = 0;
 824   1              motorStepAngle = 0;
 825   1              motorRotationAngle = 0;
 826   1              motorReducGearRatio = 0;
 827   1              ballScrew = 0;
 828   1              screwPitch = 0; 
 829   1              currentPosition = 0;
 830   1      
 831   1              saveSetting = FALSE;
 832   1              refreshDisplay = FALSE;
 833   1              initFlag = 0;
 834   1      }
 835          
 836          void InitParameters()
 837          {
 838   1              int i = 0;
 839   1              BOOL result = FALSE;
 840   1              ResetParameters();
 841   1              DebugParameters();      
 842   1              result = ReadParametersFromEEPROM();
 843   1              if (!result) // Ê¹ÓÃÄ¬ÈÏÖµ
 844   1              {
 845   2                      Debug("Use default parameters\r\n");
 846   2                      pulseSettingNum = 400; //Âö³å¸öÊý
 847   2                      pulseSettingFreq = 400; //Âö³åÆµÂÊ
 848   2                      motorStepAngle = 180; //µç»ú²½½ø½Ç
 849   2                      motorRotationAngle = 36000; //µç»úÐý×ª½Ç
 850   2                      motorReducGearRatio = 100; //µç»ú¼õËÙ±È
 851   2                      screwPitch = 200; //Ë¿¸ËË¿¾à
 852   2                      ballScrew = 200; //Ë¿¸Ëµ¼³Ì     
 853   2                      currentPosition = MOTORPOSITION_BEGIN; //µ±Ç°Î»ÖÃ 1~20
 854   2      
 855   2                      for (i = 0; i < ROTATIONANGLE_SIZE; i++)
 856   2                      {
 857   3                              rotationAngles[i] = 0x00;//i * 100;
 858   3                      }       
 859   2                      SaveParametersToEEPROM();
 860   2              } 
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 15  

 861   1      
 862   1              SyncRotationAngleNumber();
 863   1              EnableRefreshDisplay();
 864   1              DebugParameters();
 865   1      }
 866          
 867          static unsigned int GetPulseNumber(unsigned int position)
 868          {
 869   1              //DebugParameter("currentPosition", currentPosition);
 870   1              return rotationAngles[position - 1];
 871   1      }
 872          
 873          static unsigned long GetRotationAngle(unsigned int position)
 874          {
 875   1              unsigned int currentPulseNumber = 0;
 876   1              unsigned long currentRotationAngle = 0;
 877   1              unsigned long realMotorStepAngle = 0;
 878   1              currentPulseNumber = rotationAngles[position - 1];
 879   1              /*
 880   1                      ÎªÁË±ÜÃâ¸¡µãÊý¼ÆËã£¬À©´ó1000±¶
 881   1                      Êµ¼Ê±í´ïÊ½:(motorStepAngle/1000)/(motorReducGearRatio/100)*1000
 882   1                      ¼ò»¯±í´ïÊ½:100*motorStepAngle/motorReducGearRatio
 883   1              */ 
 884   1              realMotorStepAngle = (unsigned long)100 * motorStepAngle / motorReducGearRatio;
 885   1              /*
 886   1                      Êµ¼Ê±í´ïÊ½:currentPulseNumber*realMotorStepAngle/1000*100
 887   1                      ¼ò»¯±í´ïÊ½:currentPulseNumber*realMotorStepAngle/10
 888   1              */
 889   1              currentRotationAngle = (unsigned long)currentPulseNumber * realMotorStepAngle / 10;
 890   1              return currentRotationAngle;
 891   1      }
 892          
 893          static unsigned long GetBallScrew(unsigned int position)
 894          {
 895   1              unsigned int i = 0;
 896   1              unsigned long currentBallScrew = 0;
 897   1              unsigned int totalPulseNumber = 0;
 898   1              unsigned int pulseNumber = 0;
 899   1              unsigned long realMotorStepAngle = 0;
 900   1              if (position == 1)
 901   1              {
 902   2                      return 0;
 903   2              }
 904   1              for (i = 1; i < position; i++)
 905   1              {
 906   2                      pulseNumber = GetPulseNumber(i);
 907   2                      totalPulseNumber += pulseNumber;
 908   2                      #if 0
                              DebugParameter("i", i);
                              DebugParameter("pulseNumber", pulseNumber);
                              #endif
 912   2              }
 913   1              /*
 914   1                      ÎªÁË±ÜÃâ¸¡µãÊý¼ÆËã£¬À©´ó1000±¶
 915   1                      Êµ¼Ê±í´ïÊ½:(motorStepAngle/1000)/(motorReducGearRatio/100)*1000
 916   1                      ¼ò»¯±í´ïÊ½:100*motorStepAngle/motorReducGearRatio
 917   1              */ 
 918   1              realMotorStepAngle = (unsigned long)100 * motorStepAngle / motorReducGearRatio;
 919   1              /*
 920   1                      Êµ¼Ê±í´ïÊ½:totalPulseNumber*realMotorStepAngle*(screwPitch/100)/360/1000*100
 921   1                      ¼ò»¯±í´ïÊ½:totalPulseNumber*realMotorStepAngle*screwPitch/360000
 922   1              */
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 16  

 923   1              currentBallScrew = (unsigned long)totalPulseNumber * realMotorStepAngle * screwPitch / 360000;
 924   1              return currentBallScrew;
 925   1      }
 926          
 927          
 928          // ¸üÐÂÏÔÊ¾Êý¾Ý
 929          static void GetRefreshParameters()
 930          {
 931   1              pulseSettingNum = GetPulseNumber(currentPosition);
 932   1              motorRotationAngle = GetRotationAngle(currentPosition);
 933   1              ballScrew = GetBallScrew(currentPosition);
 934   1      }
 935          
 936          // Ë¢ÐÂÖ¸¶¨ÆÁÄ»µÄÊý¾Ý
 937          static void RefreshParametersByPage(int page)
 938          {
 939   1              int i;
 940   1              int addr;
 941   1              switch (page)
 942   1              {
 943   2                      case 0x00:
 944   2                              GetRefreshParameters();
 945   2                              // modified 0x0010->0x0020 0x0012->0x0022
 946   2                              SendDataToScreen(0x0020, currentPosition);
 947   2                              SendDataToScreen(0x0022, IsInitPosition()); 
 948   2                              SendLongDataToScreen(0x000A, ballScrew);
 949   2                              SendLongDataToScreen(0x000E, motorRotationAngle);
 950   2                              break;
 951   2                              
 952   2                      case 0x02:
 953   2                              GetRefreshParameters();
 954   2                              SendDataToScreen(0x0000, pulseSettingNum);
 955   2                              SendDataToScreen(0x0002, pulseSettingFreq);
 956   2                              SendDataToScreen(0x0004, motorStepAngle);
 957   2                              SendDataToScreen(0x0006, screwPitch);
 958   2                              SendDataToScreen(0x0008, motorReducGearRatio);
 959   2                              SendLongDataToScreen(0x000A, ballScrew);
 960   2                              SendLongDataToScreen(0x000E, motorRotationAngle);
 961   2                              break;
 962   2                              
 963   2                      case 0x07:
 964   2                              for (i = 0; i < ROTATIONANGLE_SIZE/2; i++)
 965   2                              {
 966   3                                      addr = SCREEN_ROTATIONANGLE_BEGIN + i * 2;
 967   3                                      SendDataToScreen(addr, rotationAngles[i]);
 968   3                              } 
 969   2                              break;
 970   2                              
 971   2                      case 0x08:
 972   2                              for (i = ROTATIONANGLE_SIZE/2; i < ROTATIONANGLE_SIZE; i++)
 973   2                              {
 974   3                                      addr = SCREEN_ROTATIONANGLE_BEGIN + i * 2;
 975   3                                      SendDataToScreen(addr, rotationAngles[i]);
 976   3                              } 
 977   2                              break;
 978   2              }       
 979   1      }
 980          
 981          // Ë¢ÐÂËùÓÐÊý¾Ý
 982          static void RefreshParameters()
 983          {
 984   1              int i;
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 17  

 985   1              int addr;
 986   1              DebugParameter("currentPosition", currentPosition);
 987   1              //pulseSettingNum = GetPulseNumber(currentPosition);
 988   1              //motorRotationAngle = GetRotationAngle(currentPosition);
 989   1              //ballScrew = GetBallScrew(currentPosition);
 990   1              GetRefreshParameters();
 991   1              SendDataToScreen(0x0000, pulseSettingNum);
 992   1              SendDataToScreen(0x0002, pulseSettingFreq);
 993   1              SendDataToScreen(0x0004, motorStepAngle);
 994   1              SendDataToScreen(0x0006, screwPitch);
 995   1              SendDataToScreen(0x0008, motorReducGearRatio);
 996   1              SendLongDataToScreen(0x000A, ballScrew);// ballScrew
 997   1              SendLongDataToScreen(0x000E, motorRotationAngle); // motorRotationAngle
 998   1      
 999   1              // modified 0x0010->0x0020 0x0012->0x0022
1000   1              SendDataToScreen(0x0020, currentPosition);
1001   1              SendDataToScreen(0x0022, IsInitPosition()); 
1002   1              for (i = 0; i < ROTATIONANGLE_SIZE; i++)
1003   1              {
1004   2                      addr = SCREEN_ROTATIONANGLE_BEGIN + i * 2;
1005   2                      SendDataToScreen(addr, rotationAngles[i]);
1006   2              }
1007   1      }
1008          
1009          void DisplayParameters()
1010          {
1011   1              if (IsRefreshDisplay())
1012   1              {
1013   2                      RefreshParametersByPage(currentPage);
1014   2                      DisableRefreshDisplay();
1015   2              }
1016   1      }
1017          
1018          void SaveParameters()
1019          {
1020   1              if (IsSaveSetting())
1021   1              {
1022   2                      SaveParametersToEEPROM();
1023   2                      SaveSnapshot();
1024   2                      DisableSaveSetting();
1025   2              }
1026   1      }
1027          
1028          BOOL ReadParametersFromEEPROM()
1029          {
1030   1              int i = 0;
1031   1              int addr = 0;
1032   1              BOOL result = FALSE;
1033   1              delay_ms(10); 
1034   1              Debug("Read parameters from EEPROM\r\n");
1035   1              // Èç¹ûµØÖ·200µÄÄÚÈÝ²»ÊÇ0XEE,¼´Ã»ÓÐÐ´Èë±êÊ¶£¬±íÊ¾µÚÒ»´Î¶ÁÈ¡
1036   1              if (IapReadByte(IAP_ADDRESS+200) == 0xEE)
1037   1              {       
1038   2                      pulseSettingNum = ((IapReadByte(IAP_ADDRESS+0) << 8) | IapReadByte(IAP_ADDRESS+1));
1039   2                      pulseSettingFreq = ((IapReadByte(IAP_ADDRESS+2) << 8) | IapReadByte(IAP_ADDRESS+3));
1040   2                      motorStepAngle = ((IapReadByte(IAP_ADDRESS+4) << 8) | IapReadByte(IAP_ADDRESS+5));
1041   2                      screwPitch = ((IapReadByte(IAP_ADDRESS+6) << 8) | IapReadByte(IAP_ADDRESS+7));
1042   2                      motorReducGearRatio = ((IapReadByte(IAP_ADDRESS+8) << 8) | IapReadByte(IAP_ADDRESS+9));
1043   2                      
1044   2                      ballScrew = ((IapReadByte(IAP_ADDRESS+10) << 24) | (IapReadByte(IAP_ADDRESS+11) << 16) + 
1045   2                                               (IapReadByte(IAP_ADDRESS+12) << 8) + IapReadByte(IAP_ADDRESS+13));
1046   2                      motorRotationAngle = ((IapReadByte(IAP_ADDRESS+14) << 24) | (IapReadByte(IAP_ADDRESS+15) << 16) + 
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 18  

1047   2                                               (IapReadByte(IAP_ADDRESS+16) << 8) + IapReadByte(IAP_ADDRESS+17));
1048   2                      // ¶ÁÈ¡µ±Ç°Î»ÖÃ
1049   2                      currentPosition = IapReadByte(IAP_ADDRESS+18);
1050   2                      // ¶ÁÈ¡Ðý×ª½Ç
1051   2                      addr = IAP_ADDRESS + 20;
1052   2                      for (i = 0; i < ROTATIONANGLE_SIZE; i++)
1053   2                      {
1054   3                              rotationAngles[i] = ((IapReadByte(addr+0) << 8) | IapReadByte(addr+1));
1055   3                              addr += 2;
1056   3                      }
1057   2                      
1058   2                      result = TRUE;
1059   2              }
1060   1      
1061   1              RestoreSnapshot();
1062   1              return result;
1063   1      }
1064          
1065          // TODO:Ã¿´ÎÖ»±£´æÐÞ¸ÄµÄÊý¾Ý
1066          BOOL SaveParametersToEEPROM()
1067          {
1068   1              int i = 0;
1069   1              int addr = 0;
1070   1              BOOL result = FALSE;
1071   1          //delay_ms(10); 
1072   1              IapEraseSector(IAP_ADDRESS); //²Á³ýEEPROM
1073   1              IapProgramByte(IAP_ADDRESS+0, (BYTE)(pulseSettingNum>>8));
1074   1              IapProgramByte(IAP_ADDRESS+1, (BYTE)pulseSettingNum);
1075   1              IapProgramByte(IAP_ADDRESS+2, (BYTE)(pulseSettingFreq>>8));
1076   1              IapProgramByte(IAP_ADDRESS+3, (BYTE)pulseSettingFreq);
1077   1              IapProgramByte(IAP_ADDRESS+4, (BYTE)(motorStepAngle>>8));
1078   1              IapProgramByte(IAP_ADDRESS+5, (BYTE)motorStepAngle);
1079   1              IapProgramByte(IAP_ADDRESS+6, (BYTE)(screwPitch>>8));
1080   1              IapProgramByte(IAP_ADDRESS+7, (BYTE)screwPitch);
1081   1              IapProgramByte(IAP_ADDRESS+8, (BYTE)(motorReducGearRatio>>8));
1082   1              IapProgramByte(IAP_ADDRESS+9, (BYTE)motorReducGearRatio);
1083   1              IapProgramByte(IAP_ADDRESS+10, (BYTE)((ballScrew>>24) & 0xFF));
1084   1              IapProgramByte(IAP_ADDRESS+11, (BYTE)((ballScrew>>16) & 0xFF));
1085   1              IapProgramByte(IAP_ADDRESS+12, (BYTE)((ballScrew>>8)  & 0xFF));
1086   1              IapProgramByte(IAP_ADDRESS+13, (BYTE)(ballScrew       & 0xFF));
1087   1      
1088   1              IapProgramByte(IAP_ADDRESS+14, (BYTE)((motorRotationAngle>>24) & 0xFF));
1089   1              IapProgramByte(IAP_ADDRESS+15, (BYTE)((motorRotationAngle>>16) & 0xFF));
1090   1              IapProgramByte(IAP_ADDRESS+16, (BYTE)((motorRotationAngle>>8)  & 0xFF));
1091   1              IapProgramByte(IAP_ADDRESS+17, (BYTE)(motorRotationAngle       & 0xFF));
1092   1                  
1093   1              // ÐÂÔö
1094   1              IapProgramByte(IAP_ADDRESS+18, (BYTE)currentPosition);
1095   1              
1096   1      
1097   1              // ±£´æÐý×ª½Ç
1098   1              addr = IAP_ADDRESS + 20;
1099   1              for (i = 0; i < ROTATIONANGLE_SIZE; i++)
1100   1              {
1101   2                      IapProgramByte(addr+0, (BYTE)(rotationAngles[i]>>8));
1102   2                      IapProgramByte(addr+1, (BYTE)rotationAngles[i]);
1103   2                      addr += 2;
1104   2              }
1105   1      
1106   1              IapProgramByte(IAP_ADDRESS+200, 0xEE); //Ð´Èë±êÖ¾Î»
1107   1              result = TRUE;
1108   1              return result;
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 19  

1109   1      }
1110          
1111          void SetParameter(int key, int dat)
1112          {
1113   1              if (key == 0x0000)//Âö³å¸öÊý
1114   1              {
1115   2                      if (dat != pulseSettingNum)
1116   2                      {
1117   3                              pulseSettingNum = dat;
1118   3                              inputChanged = TRUE;
1119   3                      }
1120   2              }
1121   1              else if (key == 0x0002) //Âö³åÆµÂÊ
1122   1              {
1123   2                      if (dat != pulseSettingFreq)
1124   2                      {
1125   3                              pulseSettingFreq = dat;
1126   3                              inputChanged = TRUE;
1127   3                      }
1128   2              }
1129   1              else if (key == 0x0004) //µç»ú²½½ø½Ç
1130   1              {
1131   2                      if (dat != motorStepAngle)
1132   2                      {
1133   3                              motorStepAngle = dat;
1134   3                              inputChanged = TRUE;
1135   3                      }
1136   2              }
1137   1              else if (key == 0x0006) // Ë¿¸ËË¿¾à
1138   1              {
1139   2                      if (dat != screwPitch)
1140   2                      {
1141   3                              screwPitch = dat;
1142   3                              inputChanged = TRUE;
1143   3                      }
1144   2              }
1145   1              else if (key == 0x0008) //µç»ú¼õËÙ±È
1146   1              {
1147   2                      if (dat != motorReducGearRatio)
1148   2                      {
1149   3                              motorReducGearRatio = dat;
1150   3                              inputChanged = TRUE;
1151   3                      }
1152   2              }
1153   1              else if (key == 0x000A) //Ë¿¸Ëµ¼³Ì
1154   1              {
1155   2                      if (dat != ballScrew)
1156   2                      {
1157   3                              ballScrew = dat;
1158   3                              inputChanged = TRUE;
1159   3                      }
1160   2              }
1161   1              else if (key == 0x000C) //µç»úÐý×ª½Ç
1162   1              {
1163   2                      if (dat != motorRotationAngle)
1164   2                      {
1165   3                              motorRotationAngle = dat;
1166   3                              inputChanged = TRUE;
1167   3                      }
1168   2              }
1169   1      }
1170          
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 20  

1171          void SetRotationAngle(int key, int dat)
1172          {
1173   1              int index = (key & 0x00FF) / 2;
1174   1              DebugParameter("index", index);
1175   1              if (dat != rotationAngles[index])
1176   1              {
1177   2                      rotationAngles[index] = dat;
1178   2                      inputChanged = TRUE;
1179   2              }
1180   1      }
1181          
1182          // ²éÕÒÊý×éÖÐ×îºóÒ»¸ö²»Îª0µÄÔªËØ£¬¼ÇÂ¼ÆäÏÂ±ê
1183          void SyncRotationAngleNumber()
1184          {
1185   1              int i = ROTATIONANGLE_SIZE -1;
1186   1              while ((i >= 0) && (rotationAngles[i] == 0))
1187   1              {
1188   2                      i--;
1189   2              }
1190   1              rotationAngleNumber = i + 1;
1191   1              DebugParameter("rotationAngleNumber", rotationAngleNumber);
1192   1              //DebugParameter("rotationAngle", rotationAngles[rotationAngleNumber - 1]);
1193   1              // 
1194   1              testPulseSettingNum = rotationAngles[0];
1195   1      }
1196          
1197          // Í¨¹ýÉèÖÃÂö³åÊýÀ´µ÷ÕûÐý×ª½Ç
1198          void SyncRotationAngle()
1199          {
1200   1              unsigned int rotationAngle;
1201   1              #if 0
                              unsigned int i;
                              // ²ßÂÔ1:Ñ­»·Ê¹ÓÃÐý×ª½Ç
                              if (rotationAngleNumber > 0)
                              {
                                      for (i = 0; i < rotationAngleNumber; i++)
                                      {
                                              rotationAngle = rotationAngles[currentRotationAngleIndex];
                                              currentRotationAngleIndex = (currentRotationAngleIndex + 1) % rotationAngleNumber;
                                              if (rotationAngle > 0)
                                              {
                                                      pulseSettingNum = rotationAngle;
                                                      return;
                                              }
                                      }
                              }
                      #else 
1218   1                      // ²ßÂÔ2:Ã¿¸öÎ»ÖÃ¶ÔÓ¦Ò»¸öÐý×ª½Ç
1219   1                      // Î»ÖÃ1¶ÔÓ¦Ðý×ª½Ç1£¬...
1220   1                      if (motorAction == MOTORDIRECTION_FORWARD)
1221   1                      {
1222   2                              rotationAngle = rotationAngles[currentPosition - 1];
1223   2                      }
1224   1                      else if (motorAction == MOTORDIRECTION_BACKWARD)
1225   1                      {
1226   2                              rotationAngle = rotationAngles[currentPosition - 1 - 1];
1227   2                      }               
1228   1                      if (rotationAngle == 65535)
1229   1                              rotationAngle = 0;
1230   1                      pulseSettingNum = rotationAngle;
1231   1                      currentPulseNum = rotationAngle;
1232   1              #endif
C51 COMPILER V7.50   PARAMETER                                                             12/29/2015 17:09:23 PAGE 21  

1233   1      }
1234          
1235          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   5177    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    127      68
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
